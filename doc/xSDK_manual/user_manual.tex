\documentclass[pdf,12pt,report,strict]{SANDreport}

\usepackage{listings}                    % needed for source code
\usepackage[usenames,dvipsnames]{xcolor} % needed for color
\usepackage{hyperref}                    % needed for URLs

\title{xSDK User Manual}
\author{Alicia Marie Klinvex}

\SANDauthor{Alicia Marie Klinvex}
\SANDnum{SAND2015-XXXX}
\SANDprintDate{November 9, 2015}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Make the code look pretty
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\definecolor{keywordColor}{HTML}{91236C}
\definecolor{stringColor}{HTML}{2D04FF}
\definecolor{commentColor}{HTML}{87AF9B}

\lstset{
  language=C++,
  backgroundcolor=\color{black!5},
  basicstyle=\tiny\ttfamily,
  numbers=left,
  breaklines=true,
  commentstyle=\color{commentColor},
  keywordstyle=\bfseries\color{keywordColor},
  stringstyle=\color{stringColor},
  showstringspaces=false
}

\renewcommand{\lstlistingname}{Program}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}

\maketitle

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Abstract
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{abstract}
Some application developers need to be able to use Trilinos together with other
libraries, such as PETSc.  This is nontrivial because these libraries all expect
the data to be stored in different ways, and the way that you call a PETSc KSP
linear solver, for instance, looks fundamentally different from the way you
would call a Belos linear solver.  The IDEAS software productivity project plans
to address this problem with the Extreme-scale Scientific Software Development
Kit (xSDK).  The xSDK will provide an interoperability layer that enables easy
installation and combined usage of the IDEAS libraries, including PETSc, Hypre,
and SuperLU.  This document describes the various interoperability layers and
how to install and use the xSDK.
\end{abstract}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Introduction
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage

\chapter*{Introduction}
The following are the libraries included in the xSDK.
{\color{red}TODO: Maybe each team should write a paragraph or so for this.}

\section{Trilinos}
The Trilinos Project is an effort to develop algorithms and enabling
technologies within an object-oriented software framework for the solution of
large-scale, complex multi-physics engineering and scientific problems. Trilinos
is organized into 66 different packages, each with a specific focus.  These
packages include linear and nonlinear solvers, preconditioners (including
algebraic multigrid), graph partitioners, eigensolvers, and optimization
algorithms, among other things.  Users are only required to install the subset
of packages related to the problems they are trying to solve.

Trilinos supports MPI+X, where X can be CUDA, OpenMP, etc.

\section{PETSc}
PETSc is a suite of data structures and routines for the scalable solution of
scientific applications modeled by partial differential equations.
It includes linear solvers, nonlinear solvers, and preconditioners.  PETSc does
not currently support threads, and it does not support solving linear systems
with multiple right-hand-sides.  While it does not include eigensolvers, there
is an eigensolver package called SLEPc built on top of PETSc with a very similar
interface.

\section{hypre}
Hypre is a library for solving large, sparse linear systems of equations on
massively parallel computers.  While it contains linear solvers and an
eigensolver called LOBPCG, it is probably most well-known for its
preconditioners.

Certain subsets of hypre are multithreaded.

\section{SuperLU}
SuperLU is a general purpose library for the direct solution of large, sparse,
nonsymmetric systems of linear equations on high performance machines. There are
three separate versions of this code: SuperLU (for sequential machines),
SuperLU\_MT (for shared memory parallel machines), and SuperLU\_DIST (for
distributed memory).
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\SANDmain

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Installation
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{xSDK Installation}
{\color{red}TODO: Ignore this.  Barry is going to take care of the circular
dependency issue; then we can revisit the installation procedure.}

\section{Using PETSc configuration script}
The easiest way to install the various xSDK libaries (Trilinos, PETSc, Hypre,
and SuperLU) is the following three step process:

\begin{enumerate}
  \item Download and unpack the PETSc tarball from
  \url{http://www.mcs.anl.gov/petsc/}, or pull from the repo via {\tt git clone
  https://bitbucket.org/petsc/petsc}.
  \item Run the PETSc configuration script.
  \item Type {\tt make}, then {\tt make install}.  Don't worry; the PETSc
  configuration script will remind you to do this.
\end{enumerate}

The PETSc configuration script is very sophisticated, as you can tell by typing
{\tt ./configure --help}.  It will produce a list for you of all the different
configuration options (organized into different categories).  The most
interesting of these configuation options is {\tt --download-<PACKAGE>}, where
{\tt PACKAGE} can be hypre, superlu, trilinos, etc.  If you install PETSc via
the following line:
\\
{\tt ./configure --prefix=<HOME>/petsc-install --download-hypre
--download-superlu}
\\
PETSc will download and install hypre and SuperLU for you, and PETSc itself will
be installed to the directory {\tt <HOME>/petsc-install}.  If PETSc encounters
any problems, such as being unable to find your MPI installation, it will output
a helpful error message explaining what the problem is and how you can fix it.

If PETSc finds itself unable to download any packages you request (because you
are behind a firewall, for instance), it will output the following message
explaining how to fix the problem:

{\tt \scriptsize
\begin{verbatim}
===============================================================================                                                                
  Trying to download http://ftp.mcs.anl.gov/pub/petsc/externalpackages/hypre-2.10.0b-p1.tar.gz for HYPRE 
=============================================================================== 
===============================================================================                                                                
  Trying to download ftp://ftp.mcs.anl.gov/pub/petsc/externalpackages/hypre-2.10.0b-p1.tar.gz for HYPRE 
===============================================================================                                                                                                                                                                                                   ******************************************************************************* UNABLE to CONFIGURE with GIVEN OPTIONS    (see configure.log for details):
-------------------------------------------------------------------------------
Unable to download package hypre from: http://ftp.mcs.anl.gov/pub/petsc/externalpackages/hypre-2.10.0b-p1.tar.gz
* If URL specified manually - perhaps there is a typo?
* If your network is disconnected - please reconnect and rerun ./configure
* Or perhaps you have a firewall blocking the download
* Alternatively, you can download the above URL manually, to /yourselectedlocation/hypre-2.10.0b-p1.tar.gz
  and use the configure option:
  --download-hypre=/yourselectedlocation/hypre-2.10.0b-p1.tar.gz
Unable to download package hypre from: ftp://ftp.mcs.anl.gov/pub/petsc/externalpackages/hypre-2.10.0b-p1.tar.gz
* If URL specified manually - perhaps there is a typo?
* If your network is disconnected - please reconnect and rerun ./configure
* Or perhaps you have a firewall blocking the download
* Alternatively, you can download the above URL manually, to /yourselectedlocation/hypre-2.10.0b-p1.tar.gz
  and use the configure option:
  --download-hypre=/yourselectedlocation/hypre-2.10.0b-p1.tar.gz
*******************************************************************************
\end{verbatim}
}

\section{Without PETSc configuration script}
If you would like to manually install Trilinos and enable the PETSc, hypre, and
SuperLU interfaces, you may specify those options in the Trilinos configuration
script (which I will call do-configure).  Note that Trilinos requires all third
party libraries to be installed before the configuration process.  An example
configuration script is below:

\begin{lstinputlisting}[caption=do-configure,label=config-script]{src/do-configure}
\end{lstinputlisting}

Let's examine this script in more detail.  Since we are interested in the PETSc
interface, we must first define {\tt PETSC\_DIR} and {\tt PETSC\_ARCH}. 
{\tt PETSC\_LIB} looks intimidating at first, but you can generate it
automatically by typing {\tt make getlinklibs} in {\tt PETSC\_DIR}.  We then
define the PETSc and hypre include paths.  Everything else looks pretty normal
until we reach lines 43--50, which enable the Epetra-based PETSc interface. 
Lines 54--58 enable the Epetra-based hypre interface.  Then lines 70--73 enable
the Tpetra-based interfaces living in the pre-Copyright package xSDKTrilinos.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{xSDK Interface Usage}
This section describes the individual interfaces and their usage.

\section{Trilinos-PETSc}
There is a two-way interface between PETSc and Trilinos which allows users to
use PETSc datatypes with Trilinos and vice-versa.

\subsection{Using PETSc Mat and Vec with Trilinos solvers}
{\color{red}TODO: Introduction and examples.}
\subsection{Is the data copied or wrapped?}
If you are using a part of Trilinos that requires Operator or RowMatrix, the
data is wrapped.  If you need a CrsMatrix specifically, the data is copied.
% To understand when data is copied, we must first understand what the data is.
% PETSc operators are of type Mat, and their vectors are of type
% Vec\footnote{PETSc does not support blocks of vectors or multiple right hand
% sides, so they have no datatype for blocks of vectors.}.  Trilinos is a bit
% more complicated in that it has two main linear algebra packages: Epetra and
% Tpetra; they have similar functionality, but Tpetra is newer and supports
% in-node parallelism.  The datatypes in these packages are summarized in table
% \ref{table:petra}.  RowMatrix is an Operator, and CrsMatrix is a RowMatrix. 
% Operator and RowMatrix are abstract, so unless you are defining your own data
% type, you will usually use a CrsMatrix\footnote{Trilinos does have other
% concrete sparse matrix implementations, but this is the most general and most
% frequently used one.}.
% 
% \begin{table}
% \centering
% \begin{tabular}{|l|c|c|}
% \hline
%  & Epetra & Tpetra\\
% \hline 
% abstract operator (can be matrix free) & Epetra\_Operator & Tpetra::Operator\\
% \hline
% abstract matrix base class & Epetra\_RowMatrix & Tpetra::RowMatrix\\
% \hline 
% basic matrix type & Epetra\_CrsMatrix & Tpetra::CrsMatrix\\
% \hline 
% wrapper of PETSc Mat & Epetra\_PETScAIJMatrix & Tpetra::PETScAIJMatrix\\
% \hline 
% single vector & Epetra\_Vector & Tpetra::Vector\\
% \hline 
% block of vectors & Epetra\_MultiVector & Tpetra::MultiVector\\
% \hline
% \end{tabular}
% \label{table:petra}
% \caption{A comparison of Epetra and Tpetra datatypes}
% \end{table}
% 
% Some Trilinos packages support both Epetra and Tpetra, such as the Krylov solver
% package Belos, which accepts either an Epetra\_Operator or a Tpetra::Operator. 
% Others like the Trilinos preconditioners have been split into an Epetra-friendly
% package Ifpack and a Tpetra-friendly package Ifpack2.  Some packages will accept
% Operators, since all they need is a matrix-vector multiply operation.  Belos,
% for instance, will happily accept an Operator, since it never needs to access
% the matrix's raw data.  Some packages need access to the values of a matrix,
% such as Ifpack; when constructing a Jacobi preconditioner, it needs to be able
% to ask the matrix for the diagonal entries.  Those packages need a RowMatrix. 
% Other packages, such as MueLu, require a CrsMatrix specifically.
% 
% Trilinos has a class called PETSc\_AIJMatrix, a subclass of RowMatrix, which
% wraps PETSc's Mat data.
\subsection{Using Trilinos datatypes with PETSc KSP solvers}
{\color{red}TODO: Introduction and examples.}

\section{Trilinos-hypre}
{\color{red}TODO: Introduction.}

In this example (Program \ref{Hypre_SolveEx.cpp}), we will examine how to use
hypre solvers and preconditioners with Tpetra objects.

\begin{lstinputlisting}[caption=Hypre\_SolveEx.cpp,label=Hypre_SolveEx.cpp]{src/Hypre_SolveEx.cpp}
\end{lstinputlisting}

\paragraph{Lines 1--5}
Include statements

\paragraph{Lines 8--24}
Typedefs and using statements to make the code more readable

\paragraph{Lines 26--30}
Set up MPI

\paragraph{Lines 32--40}
Parse command line arguments.  This program allows the user to specify how large
the problem should be and how accurately the linear system should be solved.

\paragraph{Lines 42--76}
Set up the 2D Laplace operator.

\paragraph{Lines 78--81}
Create a random right-hand-side and initialize the solution vector to 0.

\paragraph{Lines 83--94}
Set hypre options (documented in the hypre user and reference manuals found at
\url{http://computation.llnl.gov/project/linear_solvers/software.php}). In this
example, we have elected to use the conjugate gradient method with an algebraic
multigrid preconditioner.  We have specified a particular coarsening and
relaxation type.  The most important thing to note about BoomerAMG is that if
you would like to use it as a preconditioner, you must set its maximum number of
iterations to 1; otherwise, hypre will assume you meant to use it as a linear
solver.  We then set the tolerance and maximum number of iterations for hypre's
conjugate gradient solver.

\paragraph{Lines 96--106}
Create the hypre solver.  Line 99 specifies that we will be using a hypre linear
solver, and line 100 says it will be the conjugate gradient method.  Line 101
says we would also like to use BoomerAMG.  Remember that you must also set
``SetPreconditioner'' to true, or the preconditioner will not be used.  Lines
103 and 104 specify the hypre parameters such as print level, tolerance, and
maximum number of iterations.

\paragraph{Lines 108--109}
Solve the linear system.  apply actually calls the hypre linear solve routine
PCG with a BoomerAMG preconditioner, as we specified above.

In the next example (Program \ref{Hypre_BelosEx.cpp}), we will examine how to
use hypre preconditioners with Belos solvers.

\begin{lstinputlisting}[caption=Hypre\_BelosEx.cpp,label=Hypre_BelosEx.cpp]{src/Hypre_BelosEx.cpp}
\end{lstinputlisting}

\paragraph{Lines 1--86}
These lines are not substantially different from the previous example.  Again,
we set up our operator, solution vector, and right hand side.

\paragraph{Lines 88--95}
This time, we have elected not to use a hypre linear solver, so we only set the
parameters related to the AMG preconditioner.  Again, it is very important to
set the maximum number of iterations if you wish to use AMG as a preconditioner.

\paragraph{Lines 97--105}
Create the hypre preconditioner.  This time, we specify that we would like to
precondition rather than solve, since we will be using a Belos linear solver.

\paragraph{Lines 107--111}
Create a Belos::LinearProblem that encapsulates the operator, solution vector,
right-hand side, and preconditioner.  We also specify that our operator is
Hermitian so that Belos allows us to use PCG.

\paragraph{Lines 113--120}
Create a Belos linear solver.  The Belos solvers have many parameters, but we
only specify the convergence tolerance and verbosity (what information will be
printed).

\paragraph{Lines 122--123}
Solve the linear system using a Belos pseudo-block conjugate gradient solver
with hypre's BoomerAMG preconditioner.

\subsection{Is the data wrapped or copied?}
The Tpetra matrix data is deep-copied to a hypre matrix.

\section{Trilinos-SuperLU}
{\color{red}TODO.}

\end{document}
